CREATE DATABASE EmployeeDB;
USE EmployeeDB;

CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(50),
    DLOC VARCHAR(50)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(50),
    MGR_NO INT,
    HIREDATE DATE,
    SAL DECIMAL(10,2),
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PNAME VARCHAR(50),
    PLOC VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT DECIMAL(10,2),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);
INSERT INTO DEPT VALUES
(10, 'HR', 'Bengaluru'),
(20, 'IT', 'Hyderabad'),
(30, 'Finance', 'Mysuru'),
(40, 'Marketing', 'Chennai'),
(50, 'Admin', 'Delhi');
select * from DEPT;

INSERT INTO EMPLOYEE VALUES
(1001, 'Ravi',  NULL, '2020-03-15', 55000, 10),
(1002, 'Anita', 1001, '2019-08-21', 65000, 20),
(1003, 'Kiran', 1002, '2021-05-10', 48000, 20),
(1004, 'Meena', 1001, '2018-11-11', 72000, 30),
(1005, 'Suresh',1004, '2020-12-25', 50000, 30),
(1006, 'Vijay', 1002, '2022-01-05', 40000, 40);
select * from EMPLOYEE;

INSERT INTO PROJECT VALUES
(501, 'Payroll System', 'Bengaluru'),
(502, 'ERP Development', 'Hyderabad'),
(503, 'Banking App', 'Mysuru'),
(504, 'E-Commerce', 'Chennai'),
(505, 'HR Portal', 'Delhi');
select * from PROJECT;

INSERT INTO ASSIGNED_TO VALUES
(1001, 501, 'Manager'),
(1002, 502, 'Developer'),
(1003, 502, 'Tester'),
(1004, 503, 'Analyst'),
(1005, 503, 'Developer'),
(1006, 504, 'Marketing Executive'),
(1002, 501, 'Consultant');
SELECT * FROM ASSIGNED_TO;

INSERT INTO INCENTIVES VALUES
(1001, '2023-03-10', 3000),
(1002, '2023-04-15', 2000),
(1004, '2023-05-20', 1500),
(1005, '2023-06-05', 1000);
SELECT * FROM INCENTIVES;

SELECT M.ENAME AS Manager_Name, COUNT(E.EMPNO) AS No_of_Employees
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.ENAME
HAVING COUNT(E.EMPNO) = (
    SELECT MAX(EmpCount)
    FROM (
        SELECT COUNT(*) AS EmpCount
        FROM EMPLOYEE
        WHERE MGR_NO IS NOT NULL
        GROUP BY MGR_NO
    ) AS SubQuery
);


SELECT M.ENAME AS Manager_Name, M.SAL AS Manager_Salary
FROM EMPLOYEE M
WHERE M.EMPNO IN (SELECT DISTINCT MGR_NO FROM EMPLOYEE WHERE MGR_NO IS NOT NULL)
AND M.SAL > (
    SELECT AVG(E.SAL)
    FROM EMPLOYEE E
    WHERE E.MGR_NO = M.EMPNO
);

SELECT E.ENAME AS Second_Top_Level_Manager, D.DNAME AS Department
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.MGR_NO IN (
    SELECT EMPNO FROM EMPLOYEE WHERE MGR_NO IS NULL
);

SELECT *
FROM INCENTIVES
WHERE MONTH(INCENTIVE_DATE) = 1 AND YEAR(INCENTIVE_DATE) = 2019
AND INCENTIVE_AMOUNT = (
    SELECT MAX(INCENTIVE_AMOUNT)
    FROM INCENTIVES
    WHERE MONTH(INCENTIVE_DATE) = 1 AND YEAR(INCENTIVE_DATE) = 2019
    AND INCENTIVE_AMOUNT < (
        SELECT MAX(INCENTIVE_AMOUNT)
        FROM INCENTIVES
        WHERE MONTH(INCENTIVE_DATE) = 1 AND YEAR(INCENTIVE_DATE) = 2019
    )
);

SELECT E.ENAME AS Employee_Name, M.ENAME AS Manager_Name, D.DNAME AS Department
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.DEPTNO = M.DEPTNO;
